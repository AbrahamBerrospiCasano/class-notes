\RequirePackage{luatex85}
\documentclass[
  % font size
  12pt,
  % format \chapter like \section, \section like \subsection, and \subsection like \subsubsection
  headings=small,
  % spacing between paragraphs
  parskip=half-,
  % no numbers after section numbers despite roman numerals
  numbers=noendperiod,
]{scrreprt}

\setparsizes{0em}{0.45\baselineskip plus .45\baselineskip}{0em plus 1fil}

% set German as language
\usepackage[ngerman]{babel}

% set UTF-8 as encoding
\usepackage[utf8]{luainputenc}

% amsmath with improvements
\usepackage{mathtools}

% other symbols
\usepackage{latexsym}

% use GoMono as typewriter font
\usepackage[
  % otherwise bold is not available ("undefined font shape" warnings)
  type1,
  % scale to match main font size
  scale=0.88,
]{GoMono}

% need T1 font encoding for Charter,
% otherwise there will be "undefined font shape" warnings
\usepackage[T1]{fontenc}

% silence warnings
\usepackage{silence}

% use Bitstream Charter as main font,
% suppress warning due to https://github.com/latex3/latex2e/issues/299
\WarningFilter{latex}{Font shape declaration has incorrect series value `mc'.}
\usepackage[bitstream-charter]{mathdesign}
\usepackage{XCharter}

% micro-typographic adjustments
\usepackage[
  % don't deactivate extensions due to document class draft option
  final,
  % font expansion: don't stretch/shrink lines by more than 1%,
  % default of 2% looks a bit weird
  stretch=10,
  shrink=10,
]{microtype}

% Durchschnittsintegral
\usepackage{esint}

% fließende Grafiken
\usepackage{graphicx}
\usepackage{floatflt}

% own headers/footers, have different \leftmark/\rightmark despite one-sided document
\usepackage[autooneside=false]{scrlayer-scrpage}
\usepackage{lastpage}

% Farbe (Kopf-/Fußzeile)
\usepackage{color}

% relative imports
\usepackage{import}

% Unterstreichungen
\usepackage[normalem]{ulem}

% gestrichelte Linien
\usepackage{dashrule}

% umrandete Boxen
\usepackage{framed}

% verbesserte Tabellen
\usepackage{booktabs}

% mehrere Zeilen für eine Zelle
\usepackage{multirow}

% SI units
\usepackage[locale=DE,range-phrase=\;bis\;,detect-weight]{siunitx}
\DeclareSIUnit{\year}{a}
\DeclareSIUnit{\ppm}{ppm}

% Chemie
\usepackage[version=3]{mhchem}

% erweiterte Vektorpfeile (gestrichene Vektoren)
\usepackage[e]{esvect}

% angepasste Listen und Aufzählungen
\usepackage{enumitem}
\setlist[enumerate]{label=\emph{(\arabic*)}}
\renewlist{enumerate}{enumerate}{5}

% Diagramme
\usepackage[all]{xy}

% Blackboard-Fonts (auch für Kleinbuchstaben)
\usepackage{bbm}

% Querformat
\usepackage{lscape}

% Kürzen
\usepackage{cancel}

% größere Schrift, Hintergrundbilder, Fallunterscheidungen
\usepackage{fix-cm}
\usepackage{eso-pic}
\usepackage{xifthen}

% Quelltext
\usepackage{listings}
\usepackage{scrhack}

% table of contents for specific chapters
\usepackage{etoc}

% page margins
\usepackage[
  a4paper,
  left=20mm,
  right=20mm,
  top=17.5mm,
  bottom=17.5mm,
  headsep=5mm,
  footskip=10mm,
]{geometry}

% hyperref für PDF-Metainformationen und Hyperlinks
\usepackage{hyperref}
\hypersetup{
  pdfkeywords={},
  pdfauthor={Julian Valentin},
  pdfcreator={LaTeX, KOMA-Script, hyperref},
  pdfborder={0 0 0},
  unicode,
  linktoc=all,
}

% eigene Operatoren
\newcommand*{\name}[1]{\textsc{#1}}
\newcommand*{\smallpmatrix}[1]{\left(\begin{smallmatrix}#1\end{smallmatrix}\right)}

\newcommand*{\matlab}{{\fontfamily{bch}\scshape\selectfont{}Matlab}}

\renewcommand*{\sp}[1]{\left\langle{#1}\right\rangle}
\newcommand*{\norm}[1]{\left\Vert{#1}\right\Vert}

\renewcommand*{\natural}{\mathbb{N}}
\newcommand*{\integer}{\mathbb{Z}}
\newcommand*{\rational}{\mathbb{Q}}
\newcommand*{\real}{\mathbb{R}}
\newcommand*{\complex}{\mathbb{C}}

\renewcommand*{\d}{\mathop{}\!\mathrm{d}}
\newcommand*{\dr}{\d{}r}
\newcommand*{\ds}{\d{}s}
\newcommand*{\dt}{\d{}t}
\newcommand*{\du}{\d{}u}
\newcommand*{\dv}{\d{}v}
\newcommand*{\dw}{\d{}w}
\newcommand*{\dx}{\d{}x}
\newcommand*{\dy}{\d{}y}
\newcommand*{\dz}{\d{}z}
\newcommand*{\dsigma}{\d{}\sigma}
\newcommand*{\dphi}{\d{}\phi}
\newcommand*{\dvarphi}{\d{}\varphi}
\newcommand*{\dtau}{\d{}\tau}
\newcommand*{\dxi}{\d{}\xi}
\newcommand*{\dtheta}{\d{}\theta}

\newcommand*{\tp}{\mathrm{T}}

\newcommand*{\begriff}[1]{\emph{\dashuline{#1}}}

\newenvironment*{Def}[1]{\boldmath\textbf{#1}\unboldmath:\quad}{}
\newenvironment*{Lemma}[1]{\emph{Lemma} (\textsl{#1}):}{}
\newenvironment*{Satz}[1]{\uline{\emph{Satz} (\textsl{#1}):}}{}
\newenvironment*{Prop}[1]{\uline{\emph{Proposition} (\textsl{#1}):}}{}
\newenvironment*{Theorem}[1]{\uline{\emph{Theorem} (\textsl{#1}):}}{}
\newenvironment*{Kor}{\textbf{Folgerung}:}{}
\newenvironment*{Bsp}{\emph{Beispiel}:}{}
\newenvironment*{Bem}{\emph{Bemerkung}:}{}

\newcommand*{\linie}{%
  \vspace{-12pt}\textcolor{mygray}{\hdashrule{0.975\textwidth}{0.8pt}{5pt}}\vspace{-6pt}%
}

% Formeln in \textbf{...} fett schreiben
\renewcommand*{\textbf}[1]{{\bfseries\boldmath{}#1}}

% graue Farbe für Header
\definecolor{mygray}{gray}{0.5}

% scrpage2 page style
\setkomafont{pageheadfoot}{\boldmath\fontfamily{bch}\selectfont\color{mygray}\bfseries}
\setkomafont{pagenumber}{\usekomafont{pagehead}}
\KOMAoptions{headsepline=1pt}
\KOMAoptions{footsepline=1pt}

% header and footer
\pagenumbering{arabic}
\pagestyle{scrheadings}
\clearscrheadings
\ofoot{\vspace{-1.5mm}-- \pagemark \;--}

% use a section for table of contents (otherwise there is a page break before it)
\setuptoc{toc}{leveldown}

% make indent and width of numbering dynamic in table of contents
\RedeclareSectionCommands[tocdynnumwidth=true]{part,chapter,section,subsection}
\RedeclareSectionCommands[tocdynindent=true]{section,subsection}

% increase spacing for four-digit page numbers in table of contents
\RedeclareSectionCommands[tocpagenumberwidth=4em]{part}
\RedeclareSectionCommands[tocpagenumberwidth=2.7em]{chapter,section,subsection}

% don't change page style on part and chapter pages
\renewcommand*{\partpagestyle}{scrheadings}
\renewcommand*{\chapterpagestyle}{scrheadings}

% use Charter for headings, use bold math
\setkomafont{disposition}{\boldmath\fontfamily{bch}\selectfont\bfseries}

% remove "part" prefix in headings
\renewcommand*{\partformat}{\thepart\autodot\quad}

% format \part like \chapter, \chapter like \section, \section like \subsection, and
% \subsection like \subsubsection (values are taken over from KOMA-Script defaults)
\renewcommand*{\partheadstartvskip}{}
\renewcommand*{\partheadmidvskip}{}
\renewcommand*{\partheadendvskip}{}
\renewcommand*{\partheademptypage}{}
\renewcommand*{\raggedpart}{\raggedright}
\RedeclareSectionCommand[
  beforeskip=\dimexpr-2.8\baselineskip-\parskip\relax,
  afterskip=1.35\baselineskip plus 0.09\baselineskip minus 0.15\baselineskip,
  innerskip=0.5\baselineskip,
]{part}
\renewcommand*{\chapterheadstartvskip}{}
\RedeclareSectionCommand[
  beforeskip=-3.5ex plus -1ex minus -0.2ex,
  afterskip=2.3ex plus 0.2ex,
]{chapter}
\RedeclareSectionCommand[
  beforeskip=-3.25ex plus -1ex minus -0.2ex,
  afterskip=1.5ex plus 0.2ex,
]{section}
\RedeclareSectionCommand[
  beforeskip=-3.25ex plus -1ex minus -0.2ex,
  afterskip=1.5ex plus 0.2ex,
]{subsection}

\makeatletter
\AtBeginDocument{%
  %\renewcommand*{\theHchapter}{%
  %  \theHpart.\arabic{chapter}%
  %}%
  \renewcommand*{\theHlstnumber}{%
    \ifx\lst@@caption\@empty
      \lst@neglisting
    \else
      \theHlstlisting
    \fi.\thelstnumber
  }%
}
\makeatother

\begin{document}
  \input{document}
\end{document}
